#!/usr/bin/env bash 

cd `dirname $0`
source ../vcell.cfg
source ../conf/vcell_extent.cfg
source ./function
mkdir -p $cvmpath
cv_setup_cvm_check_param(){
    local ret=0
    local vhdname=""
    
    vlan=$biz_ext_vlan
    if [ $biz_ext_vlan -gt 4096 ] || [  $biz_ext_vlan -lt 0 ]
    then
        echo "biz vlan($biz_vlan) should be  0~4095"        
        ((ret++))
    fi

    cv_check_ip $cvmip
    if [ $? -ne 0 ]
    then
        echo "cvm mgmt ip($cvmip) is not valid ip"
        ((ret++))
    fi

    cv_check_ip $cvm_gateway
    if [ $? -ne 0 ]
    then
        echo "cvm gateway ip($cvm_gateway) is not valid ip"
        ((ret++))
    fi
    
    if [ -n "$cvm_biz_novlan_ip" ]
    then
        cv_check_ip $cvm_biz_novlan_ip
        if [ $? -ne 0 ]
        then
            echo "cvm_biz_novlan_ip($cvm_biz_novlan_ip) is not valid ip"
            ((ret++))
        fi
         cv_check_ip $cvm_biz_novlan_netmask
        if [ $? -ne 0 ]
        then
            echo "cvm_biz_novlan_netmask($cvm_biz_novlan_netmask) is not valid ip"
            ((ret++))
        fi
    fi


    if [ -n "$cvm_biz_vlan_ip" ]
    then
        cv_check_ip $cvm_biz_vlan_ip
        if [ $? -ne 0 ]
        then
            echo "cvm_biz_vlan_ip($cvm_biz_vlan_ip) is not valid ip"
            ((ret++))
        fi
        cv_check_ip $cvm_biz_vlan_netmask
        if [ $? -ne 0 ]
        then
            echo "cvm_biz_vlan_netmask($cvm_biz_vlan_netmask) is not valid ip"
            ((ret++))
        fi
    fi


    if [ ! -d $cv_vhd_dir ]
    then
        echo "directory cv_vhd_dir($cv_vhd_dir) is not exists!"
        ((ret++))
    fi
    if [ ! -d $cvmpath ]
    then
        echo "directoryi cvmpath($cvmpath) is not exists!"
        ((ret++))
    fi

    if [ ! -f $cvm_autorun_script ]
    then
        echo "$cvm_autorun_script is not exists!"
        ((ret++)) 
    fi

    vhdname="cloudview1.8.vhd" 
    if [ ! -f $cv_vhd_dir/$vhdname ]
    then
        echo $cv_vhd_dir/$vhdname is not exists ! 
        ((ret++))
    fi

    vhdname="vrouter_template_first.vhd" 
    if [ ! -f $cv_vhd_dir/$vhdname ]
    then
        echo $cv_vhd_dir/$vhdname is not exists ! 
        ((ret++))
    fi

    vhdname="vrouter_template.vhd"
    if [ ! -f $cv_vhd_dir/$vhdname ]
    then
        echo $cv_vhd_dir/$vhdname is not exists ! 
        ((ret++))
    fi
    return $ret
}
cv_setup_cvm_check_param
if [ $? -ne 0 ]
then
    echo "配置错误，请执行cv config 重新配置或确认文件和目录都存在。"
    echo "配置正确后，执行cv setup cvm"
    exit 1
fi

bash $cvm_autorun_script 
